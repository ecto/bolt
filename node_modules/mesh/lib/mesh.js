/*
 * Mesh client
 * Cam Pedersen
 * Sept 8, 2011
 */

var http   = require('http'),
    events = require('events');

(function(){
  var mesh = {},
      ee   = new events.EventEmitter(),
      server = http.createServer(incoming);

  module.exports = mesh;

  mesh.connect = function(host, port){
    // look for mesh server on given ip
    var options = {
      host: host || '127.0.0.1',
      port: port || '1234',
      path: '/',
      method: 'POST'
    }
    var req = http.request(options, function(res){
      console.log(this);
      var str = ''
      res.on('data', function (chunk) { str += chunk; });
      res.on('end', function () {
        console.log(str);
      });
    });
    req.write('let me in');
    req.end();
    return mesh;
  }

  mesh.on = function(hook, callback){
    return ee.on(hook, callback);
  }

  mesh.emit = function(hook, callback){
    // send the emission to the mesh server
    return ee.emit(hook, callback);
  }

  var incoming = function(){
    console.log(arguments);
  };

  process.on('uncaughtException', function(e){
    if (e.code = 'ECONNREFUSED') {
      console.log('Connection to mesh server failed. Killing process...');
      process.exit();
    } else throw e;
  });

})();

